name: "Terraform CI/CD Pipeline"

# ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡Œæ¡ä»¶
on:
  push:
    branches:
      - main  # mainãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒ¼ãƒ‰ã«pushã™ã‚‹æ™‚prod directoryãŒpushã•ã‚Œã‚‹
      - develop # developãƒ–ãƒ©ãƒ³ãƒã«pushã™ã‚‹æ™‚dev directoryãŒpushã•ã‚Œã‚‹
  pull_request:
    # PR(Pull Request)ã‚’ã—ãŸæ™‚planã®ãŸã‚ã«å®Ÿè¡Œ
    branches:
      - main  
      - develop

# [é‡è¦] OIDC èªè¨¼ã®ãŸã‚GitHubã«ãƒˆãƒ¼ã‚³ãƒ³ç™ºçµ¦æ¨©é™ã‚’è¨±å®¹ã—ã¾ã™ã€‚ 
permissions:
  id-token: write   # AWSã¨OIDCé€šä¿¡ã®ã¦ã‚å¿…é ˆæ¨©é™
  contents: read    # Gitãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ãŸã‚ã®æ¨©é™

jobs:
  terraform:
    name: "Terraform Deploy & DX Error Handling"
    runs-on: ubuntu-latest

    # ç’°å¢ƒã«ã‚ˆã£ã¦ Dynamic directory allocation
    env:
      TF_WORKING_DIR: ${{ (github.base_ref == 'main' || github.ref_name == 'main') && './workspace/prod' || './workspace/dev'}}

    # ä½œæ¥­ãƒ‡ã‚¤ãƒ¬ã‚¯ãƒˆã®æŒ‡å®š
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      # 1. ã‚³ãƒ¼ãƒ‰ã®å–å¾—
      - name: Checkout Code
        uses: actions/chekout@v4

      ## ç¾åœ¨ã® ENVã€€ç¢ºèª
      - name: Environment Check
        run: |
          echo "Trigger Event: ${{ github.event_name }}"
          echo "Target Branch: ${{ github.ref_name }}"
          echo "Selected Directory: ${{ env.TF_WORKING_DIR }}"
          echo "### Deploying to: ${{ env.TF_WORKING_DIR }}" >> $GITGUB_STEP_SUMMARY  

      # 2. AWS OIDCèªè¨¼
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-1

      # 3. Terraformã€€ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3 

      # 4. Terraform åˆæœŸåŒ–
      - name: Terraform Init
        id: init
        run: terraform init 
      
      # 5-1. format check
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check 

      # format error 
      - name: Format Error Report
        if: failure() && steps.fmt.outcome == 'failure'
        run: |
          echo "::error title=Format Error::ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚ªãƒ¼ãƒ¡ãƒƒãƒˆã«å•é¡ŒãŒãŠã‚Šã¾ã™ã€‚"
          echo "### Terraform Format å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          echo "ã‚³ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚„æ”¹è¡ŒãŒHashiCorpã®æ¨™æº–è¦ç´„ã«é•åsã¦ã„ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "- **è§£æ±ºç­–:â€»ï¼Šãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ \'terraform fmt'\ã€€ã‚’å®Ÿè¡Œã—ã€ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚â€ >> $GITHUB_STEP_SUMMARY
      
      # 6-1æ§‹æ–‡ã¨ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
      # validation error å‡¦ç†
      - name: Validate Error Report 
        if: failure() && steps.validate.outcome == 'failure'
        run: |
          echo "::error title=Validation Error::å¤‰æ•°ã®æœªå®šç¾©ã‚„æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãªã©ã®è«–ç†çš„ãªæ¬ é™¥ãŒã‚ã‚Šã¾ã™ã€‚"
          echo "### ðŸš¨ Terraform Validate å¤±æ•— (ë…¼ë¦¬ ë¬¸ë²• ì‹¤íŒ¨)" >> $GITHUB_STEP_SUMMARY
          echo "è¨˜è¿°ã•ã‚ŒãŸ \`.tf\` ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«è‡´å‘½çš„ãªæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ï¼ˆSyntax Errorï¼‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸»ãªåŽŸå› :** å­˜åœ¨ã—ãªã„å¤‰æ•°ã®å‚ç…§ã€ã‚¿ã‚¤ãƒã€å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¬ è½ãªã©ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "- **è§£æ±ºç­–:** ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ãƒ­ã‚°ï¼ˆRaw Logï¼‰ã‚’ç¢ºèªã—ã€è©²å½“è¡Œã®ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY

      # 7-1 ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´ã®è¨ˆç”»ä½œæˆ
      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
      #ã€€ãƒ—ãƒ©ãƒ³ã‚¨ãƒ©ãƒ¼å‡¦ç†
      - name: Plan Error Report
        if: failure() && steps.plan.outcome == 'failure'
        run: |
          echo "::error title=Plan Error::AWS APIã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€ã¾ãŸã¯æ¨©é™ä¸è¶³ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          echo "### ðŸš¨ Terraform Plan å¤±æ•— (ê³„íš ìƒì„± ì‹¤íŒ¨)" >> $GITHUB_STEP_SUMMARY
          echo "AWSç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹ã‚’èª­ã¿å–ã‚‹éš›ã€ã¾ãŸã¯å¤‰æ›´ã‚’è¨ˆç”»ã™ã‚‹éš›ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸»ãªåŽŸå› :** IAMæ¨©é™ï¼ˆRoleï¼‰ã®ä¸è¶³ã€ã¾ãŸã¯æ—¢å­˜ã®AWSãƒªã‚½ãƒ¼ã‚¹ã¨ã®æ·±åˆ»ãªç«¶åˆã€‚" >> $GITHUB_STEP_SUMMARY
          echo "- **è§£æ±ºç­–:** AWSã®èªè¨¼æƒ…å ±ï¼ˆOIDCï¼‰ã¨Terraformã®çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆtfstateï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
      
      # 8-1ã€€æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨
      - name: Terraform Apply
        id: apply
        if: github.event_name == 'push'
        run: terraform apply -auto-approve
      
      - name: Apply Error Report
        if: failure() && steps.apply.outcome == 'failure'
        run: |
          echo "::error title=Apply Error::ã‚¤ãƒ³ãƒ•ãƒ©ã®æ§‹ç¯‰ä¸­ã«è‡´å‘½çš„ãªéšœå®³ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å³æ™‚å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚"
          echo "### ðŸ’¥ Terraform Apply å¤±æ•— (ë°°í¬ ì¹˜ëª…ì  ì‹¤íŒ¨)" >> $GITHUB_STEP_SUMMARY
          echo "ã‚¤ãƒ³ãƒ•ãƒ©ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ä¸­ã«AWSå´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãŒä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          echo "- **å½±éŸ¿:** ã‚·ã‚¹ãƒ†ãƒ ãŒä¸å®Œå…¨ãªçŠ¶æ…‹ï¼ˆPartial Stateï¼‰ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "- **ç·Šæ€¥æŽªç½®:** AWSãƒžãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«åŠã³ãƒ­ã‚°ã‚’ç›´ã¡ã«ç¢ºèªã—ã€æ‰‹å‹•ã§ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¾ãŸã¯ä¿®æ­£ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY